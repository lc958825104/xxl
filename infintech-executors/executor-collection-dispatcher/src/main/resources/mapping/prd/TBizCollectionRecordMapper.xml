<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.infincash.cron.collection.mapper.TBizCollectionMapper">
  <resultMap id="BaseResultMap" type="com.infincash.cron.collection.table.TBizCollection">
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="fk_t_project" jdbcType="VARCHAR" property="fkTProject" />
    <result column="fk_t_user" jdbcType="VARCHAR" property="fkTUser" />
    <result column="fk_system_user" jdbcType="VARCHAR" property="fkSystemUser" />
    <result column="project_number" jdbcType="VARCHAR" property="projectNumber" />
    <result column="user_login_name" jdbcType="VARCHAR" property="userLoginName" />
    <result column="user_real_name" jdbcType="VARCHAR" property="userRealName" />
    <result column="user_phone" jdbcType="VARCHAR" property="userPhone" />
    <result column="loan_time" jdbcType="TIMESTAMP" property="loanTime" />
    <result column="deadline" jdbcType="INTEGER" property="deadline" />
    <result column="unit" jdbcType="CHAR" property="unit" />
    <result column="project_period" jdbcType="VARCHAR" property="projectPeriod" />
    <result column="first_price_loan" jdbcType="DECIMAL" property="firstPriceLoan" />
    <result column="repayment_date" jdbcType="TIMESTAMP" property="repaymentDate" />
    <result column="overdue_day_count" jdbcType="SMALLINT" property="overdueDayCount" />
    <result column="fk_t_biz_collection_overdue_bucket_interval_id" jdbcType="SMALLINT" property="fkTBizCollectionOverdueBucketIntervalId" />
    <result column="collector_login_name" jdbcType="VARCHAR" property="collectorLoginName" />
    <result column="update_time" jdbcType="TIMESTAMP" property="updateTime" />
    <result column="update_by" jdbcType="VARCHAR" property="updateBy" />
    <result column="state" jdbcType="TINYINT" property="state" javaType="int"/>
    <result column="full_repay_date" jdbcType="TIMESTAMP" property="fullRepayDate" />
    <result column="last_collection_time" jdbcType="TIMESTAMP" property="lastCollectionTime" />
    <result column="next_collection_time" jdbcType="TIMESTAMP" property="nextCollectionTime" />
    <result column="histry_collection_count" jdbcType="SMALLINT" property="histryCollectionCount" />
  </resultMap>

  <select id="queryAll" parameterType="java.lang.String" resultMap="BaseResultMap">
    select 
        t_biz.project_number, 
        t_u.login_name user_login_name, 
        t_ub.real_name user_real_name, 
        t_u.phone user_phone,
        t_biz.user_id fk_t_user,
        t_biz.fk_t_project,
        t_biz.loan_time, 
        t_biz.deadline, 
        t_biz.unit, 
        t_biz.first_price_loan, 
        t_biz.repayment_date
    from
    (
        select
          t1.user_id,
          t1.id fk_t_project,
          t1.number project_number,
          t1.loan_time,
          t1.deadline,
          t1.unit,
          t1.first_price_loan,
          t2.repayment_date      
        from t_project t1 inner join t_project_refund t2 on t1.id=t2.project_id and t1.status in ('7') 
        where t1.loan_time >  #{_parameter}
    ) t_biz
    inner join
    t_user t_u ON t_u.user_id = t_biz.user_id
    inner join 
    t_user_basis t_ub on t_ub.user_id=t_u.user_id;
  </select>
 
  <select id="queryUserByRoleId" parameterType="java.lang.String" resultType="java.util.HashMap">
    select t1.user_id, t2.real_name from t_system_user_role t1
        inner join 
        t_system_user t2 on t1.user_id = t2.user_id
    where t1.role_id = #{_parameter};
  </select>
 
  <insert id="insertBatch" parameterType="com.infincash.cron.collection.table.TBizCollection">
    insert into t_biz_collection
    <trim prefix="(" suffix=")" suffixOverrides=",">
        fk_t_project,
        fk_t_user,
        fk_system_user,
        project_number,
        user_login_name,
        user_real_name,
        user_phone,
        loan_time,
        project_period,
        first_price_loan,
        repayment_date,
        overdue_day_count,
        collector_login_name,
        state
    </trim>
    VALUES
    <foreach collection ="list" item="oneItem" index= "index" separator =",">
    (
        #{oneItem.fkTProject,jdbcType=VARCHAR},
        #{oneItem.fkTUser,jdbcType=VARCHAR},
        #{oneItem.fkSystemUser,jdbcType=VARCHAR},
        #{oneItem.projectNumber,jdbcType=VARCHAR},
        #{oneItem.userLoginName,jdbcType=VARCHAR},
        #{oneItem.userRealName,jdbcType=VARCHAR},
        #{oneItem.userPhone,jdbcType=VARCHAR},
        #{oneItem.loanTime,jdbcType=TIMESTAMP},
        #{oneItem.projectPeriod,jdbcType=VARCHAR},
        #{oneItem.firstPriceLoan,jdbcType=DECIMAL},
        #{oneItem.repaymentDate,jdbcType=TIMESTAMP},
        #{oneItem.overdueDayCount,jdbcType=SMALLINT},
        #{oneItem.collectorLoginName,jdbcType=VARCHAR},
        #{oneItem.state,jdbcType=TINYINT}
    )
    </foreach >
  </insert>
  
  <update id="updateByPrimaryKeySelective" parameterType="com.infincash.cron.collection.table.TBizCollection">
    update t_biz_collection_record
    <set>
      <if test="fkTProject != null">
        fk_t_project = #{fkTProject,jdbcType=VARCHAR},
      </if>
      <if test="fkTUser != null">
        fk_t_user = #{fkTUser,jdbcType=VARCHAR},
      </if>
      <if test="fkSystemUser != null">
        fk_system_user = #{fkSystemUser,jdbcType=VARCHAR},
      </if>
      <if test="waitOrRecord != null">
        wait_or_record = #{waitOrRecord,jdbcType=TINYINT},
      </if>
      <if test="projectNumber != null">
        project_number = #{projectNumber,jdbcType=VARCHAR},
      </if>
      <if test="userLoginName != null">
        user_login_name = #{userLoginName,jdbcType=VARCHAR},
      </if>
      <if test="userRealName != null">
        user_real_name = #{userRealName,jdbcType=VARCHAR},
      </if>
      <if test="userPhone != null">
        user_phone = #{userPhone,jdbcType=VARCHAR},
      </if>
      <if test="loanTime != null">
        loan_time = #{loanTime,jdbcType=TIMESTAMP},
      </if>
      <if test="projectPeriod != null">
        project_period = #{projectPeriod,jdbcType=VARCHAR},
      </if>
      <if test="firstPriceLoan != null">
        first_price_loan = #{firstPriceLoan,jdbcType=DECIMAL},
      </if>
      <if test="repaymentDate != null">
        repayment_date = #{repaymentDate,jdbcType=TIMESTAMP},
      </if>
      <if test="overdueDayCount != null">
        overdue_day_count = #{overdueDayCount,jdbcType=SMALLINT},
      </if>
      <if test="fkTBizCollectionOverdueBucketIntervalId != null">
        fk_t_biz_collection_overdue_bucket_interval_id = #{fkTBizCollectionOverdueBucketIntervalId,jdbcType=SMALLINT},
      </if>
      <if test="collectorLoginName != null">
        collector_login_name = #{collectorLoginName,jdbcType=VARCHAR},
      </if>
      <if test="updateTime != null">
        update_time = #{updateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="updateBy != null">
        update_by = #{updateBy,jdbcType=VARCHAR},
      </if>
      <if test="state != null">
        state = #{state,jdbcType=TINYINT},
      </if>
      <if test="fullRepayDate != null">
        full_repay_date = #{fullRepayDate,jdbcType=TIMESTAMP},
      </if>
      <if test="lastCollectionTime != null">
        last_collection_time = #{lastCollectionTime,jdbcType=TIMESTAMP},
      </if>
      <if test="nextCollectionTime != null">
        next_collection_time = #{nextCollectionTime,jdbcType=TIMESTAMP},
      </if>
      <if test="histryCollectionCount != null">
        histry_collection_count = #{histryCollectionCount,jdbcType=SMALLINT},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
</mapper>